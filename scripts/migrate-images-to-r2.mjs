#!/usr/bin/env node
/**
 * Image Migration Script - Upload all website images to Cloudflare R2
 * 
 * This script:
 * 1. Reads all images from public/images/
 * 2. Uploads them to Cloudflare R2 with organized folder structure
 * 3. Outputs the new URLs for updating the codebase
 * 
 * Usage: 
 *   node scripts/migrate-images-to-r2.mjs
 * 
 * Prerequisites:
 *   - Set environment variables in .env.local
 *   - Install dependencies: npm install @aws-sdk/client-s3 dotenv
 */

import { S3Client, PutObjectCommand, HeadObjectCommand } from '@aws-sdk/client-s3';
import { readFileSync, readdirSync, statSync, existsSync, writeFileSync } from 'fs';
import { join, extname, basename, relative } from 'path';
import { fileURLToPath } from 'url';
import { dirname } from 'path';
import { config } from 'dotenv';

// Load environment variables
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);
config({ path: join(__dirname, '..', '.env.local') });

// R2 Configuration
const R2_ACCOUNT_ID = process.env.R2_ACCOUNT_ID;
const R2_ACCESS_KEY_ID = process.env.R2_ACCESS_KEY_ID;
const R2_SECRET_ACCESS_KEY = process.env.R2_SECRET_ACCESS_KEY;
const R2_BUCKET_NAME = process.env.R2_BUCKET_NAME || 'seetara-assets';
const R2_PUBLIC_URL = process.env.NEXT_PUBLIC_R2_PUBLIC_URL;

// Validate configuration
if (!R2_ACCOUNT_ID || !R2_ACCESS_KEY_ID || !R2_SECRET_ACCESS_KEY || !R2_PUBLIC_URL) {
  console.error('âŒ Missing R2 configuration. Please set these in .env.local:');
  console.error('   - R2_ACCOUNT_ID');
  console.error('   - R2_ACCESS_KEY_ID');
  console.error('   - R2_SECRET_ACCESS_KEY');
  console.error('   - NEXT_PUBLIC_R2_PUBLIC_URL');
  process.exit(1);
}

// Initialize S3 Client for R2
const r2Client = new S3Client({
  region: 'auto',
  endpoint: `https://${R2_ACCOUNT_ID}.r2.cloudflarestorage.com`,
  credentials: {
    accessKeyId: R2_ACCESS_KEY_ID,
    secretAccessKey: R2_SECRET_ACCESS_KEY,
  },
});

// MIME type mapping
const mimeTypes = {
  '.jpg': 'image/jpeg',
  '.jpeg': 'image/jpeg',
  '.png': 'image/png',
  '.gif': 'image/gif',
  '.webp': 'image/webp',
  '.svg': 'image/svg+xml',
};

// Get all image files recursively
function getAllImages(dirPath, arrayOfFiles = []) {
  const files = readdirSync(dirPath);

  files.forEach((file) => {
    const fullPath = join(dirPath, file);
    if (statSync(fullPath).isDirectory()) {
      getAllImages(fullPath, arrayOfFiles);
    } else {
      const ext = extname(file).toLowerCase();
      if (mimeTypes[ext]) {
        arrayOfFiles.push(fullPath);
      }
    }
  });

  return arrayOfFiles;
}

// Check if object already exists in R2
async function objectExists(key) {
  try {
    await r2Client.send(new HeadObjectCommand({
      Bucket: R2_BUCKET_NAME,
      Key: key,
    }));
    return true;
  } catch (error) {
    return false;
  }
}

// Upload a single image to R2
async function uploadImage(localPath, imagesDir) {
  const relativePath = relative(imagesDir, localPath);
  const r2Key = `website/${relativePath.replace(/\\/g, '/')}`;
  const ext = extname(localPath).toLowerCase();
  const contentType = mimeTypes[ext] || 'application/octet-stream';

  // Check if already uploaded
  const exists = await objectExists(r2Key);
  if (exists) {
    console.log(`â­ï¸  Skipping (already exists): ${r2Key}`);
    return {
      localPath: `/images/${relativePath.replace(/\\/g, '/')}`,
      r2Key,
      r2Url: `${R2_PUBLIC_URL}/${r2Key}`,
      skipped: true,
    };
  }

  // Read file
  const fileBuffer = readFileSync(localPath);

  // Upload to R2
  await r2Client.send(new PutObjectCommand({
    Bucket: R2_BUCKET_NAME,
    Key: r2Key,
    Body: fileBuffer,
    ContentType: contentType,
    CacheControl: 'public, max-age=31536000, immutable',
    Metadata: {
      'original-name': basename(localPath),
      'upload-date': new Date().toISOString(),
      'migrated-from': 'public/images',
    },
  }));

  console.log(`âœ… Uploaded: ${r2Key}`);
  
  return {
    localPath: `/images/${relativePath.replace(/\\/g, '/')}`,
    r2Key,
    r2Url: `${R2_PUBLIC_URL}/${r2Key}`,
    skipped: false,
  };
}

// Generate the images.ts constants file
function generateImagesFile(uploadResults) {
  const imageMap = {};
  
  uploadResults.forEach(result => {
    // Convert path like /images/products/tote-black.jpg to PRODUCTS_TOTE_BLACK
    const key = result.localPath
      .replace('/images/', '')
      .replace(/\.[^/.]+$/, '') // remove extension
      .replace(/[^a-zA-Z0-9]/g, '_')
      .toUpperCase();
    
    imageMap[key] = result.r2Url;
  });

  const content = `/**
 * Centralized Image URLs - All website images served from Cloudflare R2
 * 
 * This file is auto-generated by scripts/migrate-images-to-r2.mjs
 * Do NOT edit manually. Run the migration script to update.
 * 
 * Generated: ${new Date().toISOString()}
 */

// R2 Base URL from environment
const R2_PUBLIC_URL = process.env.NEXT_PUBLIC_R2_PUBLIC_URL || '${R2_PUBLIC_URL}';

/**
 * Helper to get R2 URL for an image path
 */
export function getR2ImageUrl(path: string): string {
  // If already a full URL, return as-is
  if (path.startsWith('http://') || path.startsWith('https://')) {
    return path;
  }
  // Remove leading slash if present
  const cleanPath = path.startsWith('/') ? path.slice(1) : path;
  // Convert images/ to website/ for R2 structure
  const r2Path = cleanPath.replace('images/', 'website/');
  return \`\${R2_PUBLIC_URL}/\${r2Path}\`;
}

// =====================================================
// LOGO
// =====================================================
export const LOGO = '${imageMap['LOGO_LOGO'] || `${R2_PUBLIC_URL}/website/logo/logo.png`}';

// =====================================================
// HERO SECTION
// =====================================================
export const HERO_BAG = '${imageMap['HERO_BAG'] || `${R2_PUBLIC_URL}/website/hero-bag.jpg`}';

// =====================================================
// PRODUCTS
// =====================================================
export const PRODUCTS = {
  TOTE_BLACK: '${imageMap['PRODUCTS_TOTE_BLACK'] || `${R2_PUBLIC_URL}/website/products/tote-black.jpg`}',
  TOTE_COGNAC: '${imageMap['PRODUCTS_TOTE_COGNAC'] || `${R2_PUBLIC_URL}/website/products/tote-cognac.jpg`}',
  TOTE_OLIVE: '${imageMap['PRODUCTS_TOTE_OLIVE'] || `${R2_PUBLIC_URL}/website/products/tote-olive.jpg`}',
  TOTE_BLACK_DETAIL: '${imageMap['PRODUCTS_TOTE_BLACK_DETAIL'] || `${R2_PUBLIC_URL}/website/products/tote-black-detail.jpg`}',
  TOTE_COGNAC_DETAIL: '${imageMap['PRODUCTS_TOTE_COGNAC_DETAIL'] || `${R2_PUBLIC_URL}/website/products/tote-cognac-detail.jpg`}',
  SHOULDER_BLACK: '${imageMap['PRODUCTS_SHOULDER_BLACK'] || `${R2_PUBLIC_URL}/website/products/shoulder-black.jpg`}',
  SHOULDER_MAROON: '${imageMap['PRODUCTS_SHOULDER_MAROON'] || `${R2_PUBLIC_URL}/website/products/shoulder-maroon.jpg`}',
  HOBO_BROWN: '${imageMap['PRODUCTS_HOBO_BROWN'] || `${R2_PUBLIC_URL}/website/products/hobo-brown.jpg`}',
  MAKE_PURSE: '${imageMap['PRODUCTS_ADDED_MAKE_PURSE__3_'] || `${R2_PUBLIC_URL}/website/products/Added Make Purse (3).png`}',
  PLACEHOLDER: '${imageMap['PRODUCTS_PLACEHOLDER'] || `${R2_PUBLIC_URL}/website/products/tote-black.jpg`}',
} as const;

// =====================================================
// ABOUT & FOUNDER SECTION
// =====================================================
export const ABOUT = {
  CRAFTSMANSHIP: '${imageMap['CRAFTSMANSHIP'] || `${R2_PUBLIC_URL}/website/craftsmanship.png`}',
  CRAFTSMANSHIP_JPG: '${imageMap['CRAFTSMANSHIP'] || `${R2_PUBLIC_URL}/website/craftsmanship.jpg`}',
  DETAIL: '${imageMap['DETAIL'] || `${R2_PUBLIC_URL}/website/detail.jpg`}',
} as const;

export const FOUNDER = {
  MAIN: '${imageMap['FOUNDER'] || `${R2_PUBLIC_URL}/website/founder.jpg`}',
  WORKING: '${imageMap['FOUNDER_WORKING'] || `${R2_PUBLIC_URL}/website/founder-working.jpg`}',
  ARTISANS: '${imageMap['FOUNDER_ARTISANS'] || `${R2_PUBLIC_URL}/website/founder-artisans.jpg`}',
  SIGNATURE: '${imageMap['SIGNATURE'] || `${R2_PUBLIC_URL}/website/signature.png`}',
} as const;

// =====================================================
// TESTIMONIALS / CUSTOMERS
// =====================================================
export const TESTIMONIALS = {
  CUSTOMER_1: '${imageMap['TESTIMONIALS_CUSTOMER_1'] || `${R2_PUBLIC_URL}/website/testimonials/customer-1.jpg`}',
  CUSTOMER_2: '${imageMap['TESTIMONIALS_CUSTOMER_2'] || `${R2_PUBLIC_URL}/website/testimonials/customer-2.jpg`}',
  CUSTOMER_3: '${imageMap['TESTIMONIALS_CUSTOMER_3'] || `${R2_PUBLIC_URL}/website/testimonials/customer-3.jpg`}',
} as const;

// =====================================================
// TRUST & CERTIFICATES
// =====================================================
export const CERTIFICATES = {
  REGISTRATION: '${imageMap['CERTIFICATES_REGISTRATION'] || `${R2_PUBLIC_URL}/website/certificates/registration.jpg`}',
  PAN: '${imageMap['CERTIFICATES_PAN'] || `${R2_PUBLIC_URL}/website/certificates/pan.jpg`}',
} as const;

// =====================================================
// ALL IMAGES EXPORT (for programmatic access)
// =====================================================
export const IMAGES = {
  LOGO,
  HERO_BAG,
  ...PRODUCTS,
  ...ABOUT,
  ...FOUNDER,
  ...TESTIMONIALS,
  ...CERTIFICATES,
} as const;

// Type for image keys
export type ImageKey = keyof typeof IMAGES;
`;

  return content;
}

// Main migration function
async function migrateImages() {
  console.log('\nðŸš€ Starting Image Migration to Cloudflare R2...\n');
  console.log(`ðŸ“ Bucket: ${R2_BUCKET_NAME}`);
  console.log(`ðŸŒ Public URL: ${R2_PUBLIC_URL}\n`);

  const imagesDir = join(__dirname, '..', 'public', 'images');
  
  if (!existsSync(imagesDir)) {
    console.error(`âŒ Images directory not found: ${imagesDir}`);
    process.exit(1);
  }

  // Get all image files
  const imageFiles = getAllImages(imagesDir);
  console.log(`ðŸ“· Found ${imageFiles.length} images to migrate\n`);

  // Upload all images
  const results = [];
  let uploadedCount = 0;
  let skippedCount = 0;

  for (const imagePath of imageFiles) {
    try {
      const result = await uploadImage(imagePath, imagesDir);
      results.push(result);
      if (result.skipped) {
        skippedCount++;
      } else {
        uploadedCount++;
      }
    } catch (error) {
      console.error(`âŒ Failed to upload ${imagePath}:`, error.message);
    }
  }

  console.log('\nðŸ“Š Migration Summary:');
  console.log(`   âœ… Uploaded: ${uploadedCount}`);
  console.log(`   â­ï¸  Skipped: ${skippedCount}`);
  console.log(`   ðŸ“ Total: ${results.length}`);

  // Generate the images.ts file
  const imagesFileContent = generateImagesFile(results);
  const imagesFilePath = join(__dirname, '..', 'src', 'lib', 'images.ts');
  writeFileSync(imagesFilePath, imagesFileContent);
  console.log(`\nâœ… Generated: src/lib/images.ts`);

  // Output migration map for reference
  console.log('\nðŸ“‹ Image URL Mapping:\n');
  results.forEach(result => {
    console.log(`   ${result.localPath}`);
    console.log(`   â†’ ${result.r2Url}\n`);
  });

  console.log('\nâœ¨ Migration complete!');
  console.log('\nNext steps:');
  console.log('1. Update all components to import from "@/lib/images"');
  console.log('2. Replace local paths with R2 URLs');
  console.log('3. Delete public/images folder after verifying');
}

// Run migration
migrateImages().catch(console.error);

